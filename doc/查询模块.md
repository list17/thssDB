# 查询模块设计文档
曾正 李胜涛 郑炜熹

## 实现功能

* create database
* create table  
* drop database
* delete
* drop table
* insert
* select
* use database
* show database
* show table
* show meta
* quit
* update

客户端与服务端连接功能完成, 可以执行上述支持的所有命令并显示查询消息以及报错通知. 但该功能还未完全测试, 可能会有错误出现, 后续会继续改进. 部分样例如下  
![展示](./客户端展示1.png)

## 该部分实现的进阶要求功能
* 支持三张表以上的join并支持`,`与join的混用
* 支持多列主键
* where语句支持逻辑运算符
* 查询语法中支持换名操作, 如`select a.id, b.id from user as a join school as b on a.school = b.id;`类似语句.

## 结构部分
该部分代码主要位于目录expression, parser, query, statement目录之中. 为了避免篇幅过长, 所以将一些重复或者容易从命名上看功能的部分省略或只介绍其中一项.

### expression
该目录下主要是对于解析过程中的条件表达式或者常量表达式的定义.

### Variable
定义了一个变量的interface, `ColumnVariable`, `ConstantVariable`实现该interface, 其中`ColumnVariable`
用于条件中的column name的解析, 如在`where a.id = 1`的部分中`a.id`为该类. `ConstantVariable`则用于常量的解析
其中包括`String`, `Double`和`Long`三种类型. 具体如何解析则是`antlr`部分的问题.

### Expression
定义了一个表达式的interface, `CompareExpression`和`LogicalExpression`实现该interface, 其中`CompareExpression`
表示比较的表达式, 如`a.id = 1`, 而`LogicalExpression`表示逻辑连接词的运算, 如`a.id = 1 && b.id = 2`.

## parser
该目录下是`antlr`解析部分的实现, 采用了`antlr`的visitor模式, 主要实现代码位于`Visitor`类中. 用于对`antlr`语法的解析并
生成对应的`statement`语句用于执行(该部分详见下面的statement), 

## query
用于执行结果的存储, 其中主要部分位于`QueryTable`之中, 此类用于对于查询结果的存储, 如`show databases`, `select`语句等
均会返回一个该类的实例, 其中的存储结果(`columns`和`rows`)用于展示到前端. 

## statement
查询实现的最主要部分, 其中每一个`statement`均实现`Statement`的interface, 该interface中有一个`execute`的方法,
其余`statement`均是在重载该方法来实现该`statement`的任务, 这样做的好处是方便后面执行的统一化.  
如`SelectStatement` 通过`antlr`获取到自己需要的数据之后通过`Execute`函数查询结果并将结果存储到一个`QueryTable`之中
其他实现途径与此一致但在自己的数据获取方面可能有些出入, 如`CreateTableStatement` 需要用到`ColumnDefinition
`以及实现该interface的`ConstraintColumnStatement`和`ColumnStatement`来实现自己的数据结构, 获取数据并通过`ColumnDefinition`
中的`attach`方法来实现自己的`Execute`方法.

## 单元测试
位于`ThssDB/src/test/java/cn/edu/thssdb/query/statementExecuteTest.java`中,建议测试前清空`ThssDB\data`文件夹(不清空应该也不会出现问题,
该目录不存在应该也不会出现问题).